cd `dirname $0`

#these config changes are needed to allow qemu to boot
# we mount the image locally then make the changes then umount
#the image will no longer boot as an sdcard

./box-mount

echo " enable ssh "
sudo tee boot/ssh >/dev/null <<EOF
OK
EOF
sudo tee root/boot/ssh >/dev/null <<EOF
OK
EOF

echo " setup boot config to 720p with no overscan and a 32meg gfx card"
sudo tee boot/config.txt >/dev/null <<EOF
gpu_mem=32
hdmi_force_hotplug=1
hdmi_drive=2
hdmi_group=1
config_hdmi_boost=4
#set 720p with no overscan
hdmi_mode=4
disable_overscan=1
EOF

echo " disable console blank and raspi logo "
sudo tee boot/cmdline.txt >/dev/null <<EOF
dwc_otg.lpm_enable=0 console=ttyAMA0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait logo.nologo=1 consoleblank=0
EOF

#backup original card versions
sudo cp root/etc/ld.so.preload root/etc/ld.so.preload.card
sudo cp root/etc/fstab root/etc/fstab.card

#this is needed to allow qemu to boot
sudo tee root/etc/ld.so.preload.qemu >/dev/null <<EOF
EOF

#use these for qemu booting
sudo tee root/etc/fstab.qemu >/dev/null <<EOF
proc             /proc           proc    defaults          0       0
/dev/sda2        /               ext4    defaults,noatime  0       1
EOF

./box-umount
