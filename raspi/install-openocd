cd `dirname $0`
. ./box-settings


./box-up-wait

./ssh " sudo apt update "

# this version is too old
#./ssh " sudo apt -y install openocd "

# so build latest version

./ssh " sudo apt -y install build-essential "
./ssh " sudo apt -y install git "
./ssh " sudo apt -y install make "
./ssh " sudo apt -y install libtool "
./ssh " sudo apt -y install pkg-config "
./ssh " sudo apt -y install autoconf "
./ssh " sudo apt -y install automake "
./ssh " sudo apt -y install texinfo "
./ssh " sudo apt -y install libusb-1.0-0-dev "

./ssh " git clone https://git.code.sf.net/p/openocd/code openocd "

./ssh " cd openocd && ./bootstrap "
./ssh " cd openocd && ./configure CFLAGS=-Wno-error --enable-sysfsgpio --enable-bcm2835gpio "
./ssh " cd openocd && make "
./ssh " cd openocd && sudo make install "


./box-down


./box-mount

echo " autostart openocd "
tee root/home/pi/swd.boot.sh >/dev/null <<EOF
while true; do 
# try pi1
sudo openocd/src/openocd -d2 -s /home/pi/openocd/tcl -f interface/raspberrypi-native.cfg  -c " bindto 0.0.0.0 ; transport select swd " -f target/nrf52.cfg -c " init ; nrf5 info " 2>&1 | tee -a /home/pi/swd.log
# try pi2
sudo openocd/src/openocd -d2 -s /home/pi/openocd/tcl -f interface/raspberrypi2-native.cfg -c " bindto 0.0.0.0 ; transport select swd " -f target/nrf52.cfg -c " init ; nrf5 info " 2>&1 | tee -a /home/pi/swd.log
# wait to try again
echo " Well that did not work... will try again in 10 secs. " | tee -a /home/pi/swd.log
sleep 10
done
EOF
chmod +x root/home/pi/openocd.boot.sh

./box-umount

